# exp_004: Wave数判定 (pHash 16x16 + HSV白色抽出 + ROI分割)

## ステータス

| 項目 | 値 |
|---|---|
| 状態 | ✅ 完了 |
| 管理番号 | F-004 |
| 統合先 | - (未統合) |
| 作成日 | 2026-02-22 |
| 最終更新 | 2026-02-23 |

## 目的

ゲーム画面のWave表示（WAVE 1~5）をpHashで判定できるか検証する。

> EXTRA WAVE の認識は F-005 に分離。

## 手法

1. **ROI切り出し**: FHD画像の固定位置 (76, 35, 199, 80) から123x45pxを切り出し
2. **HSV白色テキスト抽出**: BGR→HSV変換後、`InRange(lower=[0,0,210], upper=[180,80,255])` で白色ピクセルのみ抽出
3. **モルフォロジーオープニング**: 3x3カーネルで背景ノイズ（霧・エフェクト等の映り込み）を除去
4. **2段判定**:
   - 左90pxで「WAVE」テキストの有無を判定 (pHash 16x16)
   - 一致 → 右33pxで数字(1~5)を判定 (pHash 16x16)

## 実行方法

```bash
# テンプレート作成 (Wave 1~5)
uv run python experiments/exp_004_wave_number_recognition/main.py \
    --create-template --wave-number 1 --image <Wave1表示の画像> --debug

# ディレクトリ一括判定
uv run python experiments/exp_004_wave_number_recognition/main.py \
    --image-dir data/test_fixtures/wave/

# デバッグモード（NG画像の詳細表示）
uv run python experiments/exp_004_wave_number_recognition/main.py \
    --image-dir data/test_fixtures/wave/ --debug

# 閾値を変えて検証
uv run python experiments/exp_004_wave_number_recognition/main.py \
    --image-dir data/test_fixtures/wave/ --threshold 116
```

## 最終結果

### パラメータ

| 項目 | 値 |
|---|---|
| ROI | (76, 35, 199, 80) = 123x45px |
| WAVEテキスト部 | 左90px |
| 数字部 | 右33px |
| pHashサイズ | 16x16 (256bit) — DCTベース独自実装 |
| HSVフィルタ | V≥210, S≤80 |
| モルフォロジー | オープニング 3x3 |
| 閾値 | 116 |
| 有効閾値範囲 | 111~122（幅12、マージン±5~6） |

### 精度（最終: ROI 123x45px, pHash 16x16, 閾値=116）

| 対象 | 正解率 | テスト画像数 | 備考 |
|---|---|---|---|
| Wave 1 | 100% (25/25) | 25枚 | 霧イベント中のフレームも含めて全問正解 |
| Wave 2 | 100% (15/15) | 15枚 | |
| Wave 3 | 100% (21/21) | 21枚 | |
| Wave 4 | 100% (6/6) | 6枚 | |
| Wave 5 | 100% (8/8) | 8枚 | digit_4 vs digit_5 の誤分類も解消 |
| Negative | 100% (29/29) | 29枚 | |
| **総合** | **100% (104/104)** | **104枚** | 目標95%を達成 |

> extra/ の5枚はF-005に移管予定のため評価対象外（現在はNONE判定=正常動作）

### 速度

| 処理 | 時間 | 環境 |
|---|---|---|
| 認識 (CPU) | 0.33ms | AMD Ryzen 7, 64GB RAM |

## 最適化の経緯

### pHashサイズ比較

| pHashサイズ | ROI | 閾値 | 総合精度 | 有効閾値範囲 | 備考 |
|---|---|---|---|---|---|
| 8x8 (64bit) | 161x45 | 24 | 94% (102/109) | 24~26（幅3） | digit_4/5 誤分類あり |
| 16x16 (256bit) | 161x45 | 120 | 100% (104/104) | 116~124（幅9） | digit_4/5 解消 |
| **16x16 (256bit)** | **123x45** | **116** | **100% (104/104)** | **111~122（幅12）** | **最終採用** |

### ROI調整の経緯

| 段階 | ROI | サイズ | WAVEテキスト | 数字部 | pHash | 精度 | 備考 |
|---|---|---|---|---|---|---|---|
| 初期 (ShakeScouter-NW由来) | (38, 35, 238, 80) | 200x45px | 左128px | 右72px | 8x8 | — | |
| 右端削減 | (38, 35, 199, 80) | 161x45px | 左128px | 右33px | 8x8 | 94% | 右端39pxは余白で不要 |
| 左端削減（8x8で試行） | (76, 35, 199, 80) | 123x45px | 左90px | 右33px | 8x8 | 91% | 8x8では精度低下、不採用 |
| pHash 16x16化 | (38, 35, 199, 80) | 161x45px | 左128px | 右33px | 16x16 | 100% | digit_4/5解消 |
| **左端削減（16x16で再試行）** | **(76, 35, 199, 80)** | **123x45px** | **左90px** | **右33px** | **16x16** | **100%** | **マージン拡大、最終採用** |

### 閾値別精度（最終: ROI 123x45px, pHash 16x16）

| 閾値 | 総合精度 | Negative正棄却率 | 備考 |
|---|---|---|---|
| 108 | 98% (102/104) | 100% | |
| 111 | 100% (104/104) | 100% | 有効範囲の下限 |
| **116** | **100% (104/104)** | **100%** | **推奨値（範囲中央）** |
| 122 | 100% (104/104) | 100% | 有効範囲の上限 |
| 124 | 98% (102/104) | 98% | Negative誤検出発生 |

### パラメータ最適化の経緯

1. **初期実装** (ROI 200x45, V≥200, kernel=なし, threshold=10, pHash 8x8): 77% → 背景ノイズに弱い
2. **モルフォロジー追加** (ROI 200x45, V≥200, kernel=3x3, threshold=20): 92% → 改善
3. **HSVフィルタ調整** (ROI 200x45, V≥210, kernel=3x3, threshold=22): 97% → 霧対策
4. **ROI右端削減** (ROI 161x45, threshold=22): 93% → テンプレート元画像変更の影響あり
5. **ROI左端削減試行** (ROI 123x45, pHash 8x8): 91% → WAVEテキスト判定が悪化、不採用
6. **閾値調整** (ROI 161x45, threshold=24): 94%
7. **pHash 16x16化** (ROI 161x45, threshold=120): **100%** → digit_4/5誤分類・霧イベントNG解消
8. **ROI左端削減再試行** (ROI 123x45, pHash 16x16, threshold=116): **100%** → マージン拡大、最終採用

## 知見

- **pHash 16x16 が 8x8 より優れる**: 256bit のハッシュにより数字間の距離差が拡大。digit_4 vs digit_5 の距離差が 3 → 48 に改善
- **16x16 では左端余白削減が有効**: 8x8 では精度低下した左38px削減が、16x16 では逆にマージン拡大（有効閾値範囲 9 → 12）
- **DCTベース独自実装**: `cv2.img_hash.PHash` は 8x8 固定のため、32x32リサイズ → DCT → 低周波16x16係数 → 平均値二値化で独自実装
- **霧イベント（特殊Wave「霧」）は認識が困難**: 背景全体が白くなり、HSVフィルタで除去しきれない。V≥210 + モルフォロジーオープニングで大幅に改善。16x16化で完全対応
- **HSVフィルタのV下限が認識精度に大きく影響**: V≥200→V≥210への変更で、通常フレームの精度を維持しつつ霧フレームのノイズを大幅に削減
- **モルフォロジーオープニング（3x3）が効果的**: 小さなノイズ点を除去しつつテキスト形状を維持。5x5は過度にテキストを侵食するため不採用
- **pHashは処理速度が極めて高速（0.33ms）**: 1ms目標を大幅にクリア
- **テンプレート画像の選択が重要**: クリーンな背景のフレームを選ぶことで安定した認識が可能
- **テンプレート元画像の記録が必要**: 元画像の追跡ができないと精度変化の原因特定が困難。再作成時はREADMEに記録すること
- **ROI余白の影響**: pHashは圧縮するため、余白が多いと文字形状のビット数が減り判別力が低下する。タイトな切り出しが有効（ただしpHashサイズに依存）

## テンプレート一覧

| ファイル | 内容 | 配置先 |
|---|---|---|
| `wave_text.npy` | 「WAVE」テキスト部のpHashハッシュ (90x45→16x16) | `assets/templates/wave/` |
| `digit_1.npy` ~ `digit_5.npy` | 数字1~5のpHashハッシュ (33x45→16x16) | `assets/templates/wave/` |
| `extra_wave.npy` | F-005用（F-004では未使用） | `assets/templates/wave/` |

## 統合メモ

- ROI座標はハードコード → 統合時はconfig引数に変更
- HSVフィルタの閾値（V≥210, S≤80）も同様にconfig化
- デフォルト閾値は116（設計書初期値の10から変更）
- `cv2.imshow` のデバッグ表示は `cv2.imwrite` によるファイル出力に変更済み
- `print` は `logging` に変更
- テンプレートディレクトリのパスはコンストラクタ引数で受け取る
- pHash計算は `WaveNumberRecognizer.compute_phash()` 静的メソッド（`cv2.img_hash.PHash` は使用しない）
