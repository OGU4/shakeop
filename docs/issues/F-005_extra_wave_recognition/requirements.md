# [F-005] Extra Wave判定 — 要求仕様書

## 基本情報

| 項目 | 内容 |
|---|---|
| 管理番号 | F-005 |
| 作成日 | 2026-02-23 |
| ステータス | 📋 未着手 |
| 関連実験 | 未定 |
| 前提機能 | F-004（Wave数判定）、F-003（GUI認識ビューワー） |
| 経緯 | F-004 から EXTRA WAVE 認識を分離。ROI位置・サイズが通常Waveと異なるため独立管理とする |

## 背景・目的

サーモンランNWの通常バイトでは、Wave 1~3 クリア後に一定確率で「EXTRA WAVE」が発生する。
EXTRA WAVE はオカシラシャケとの戦闘であり、通常Waveとは異なるゲーム進行となる。

F-004 では通常Wave (1~5) と EXTRA WAVE を同一の認識器で扱っていたが、
ROI位置・サイズの調整を考慮すると独立した認識機能として分離する方が適切であるため、本機能として切り出す。

## 認識対象

| 表示 | 説明 |
|---|---|
| EXTRA WAVE | 通常バイト限定の特殊Wave。オカシラゲージ合計値に応じた確率で発生 |

## 画面上の表示仕様

### 表示パターン

- 「EXTRA WAVE」が一体のテキストとして表示される（数字なし）
- 通常Wave (「WAVE N」) とはテキスト内容・レイアウトが異なる

### 表示色・背景

- テキストは **白色系** で描画
- **背景は透過** であり、ゲーム内の画面が映り込む（F-004と同様）
- HSVフィルタによる白色テキスト抽出が前処理として必要

### ROI参考情報

F-004 では以下のROIを使用していた（ShakeScouter-NW由来）:

| 項目 | 値（FHD 1920x1080 基準） |
|---|---|
| ROI矩形 | left=38, top=35, right=238, bottom=80 |
| ROIサイズ | 200 x 45 px |

> EXTRA WAVE は通常Waveとテキスト長が異なるため、ROIの最適値は別途検証が必要。

### 表示タイミング

- EXTRA WAVE 開始時に表示される
- Wave途中でゲームオーバー（全滅）になった場合は表示が消える

### 表示されない画面

- マッチング待ち・ロビー画面
- 通常Wave (1~5) 進行中
- Wave間の休憩時間
- リザルト画面
- その他 EXTRA WAVE 以外の全画面

## スコープ

**スコープ内:**
- 1枚の静止画に対して「EXTRA WAVE 表示あり」または「EXTRA WAVE 表示なし」を返す判定機能

**スコープ外（将来要求として扱う）:**
- EXTRA WAVE 遷移の検出（表示の出現・消滅のトリガー検知）
- 時系列安定化（複数フレームの多数決）
- ゲーム状態FSMとの連携

## 要求事項

### 必須要求 (MUST)

- EXTRA WAVE の正検出率: 95%以上
- EXTRA WAVE 表示なし画面の正棄却率: 95%以上
- pHash ベースの認識を基本方針とする
- FHD (1920x1080) の静止画を入力として受け付けること

### 推奨要求 (SHOULD)

- 認識処理時間: 1フレームあたり 1ms 以内
- F-003 GUI認識ビューワーのプラグインとして動作すること

### 将来要求 (COULD)

- 動画入力への対応（F-003統合で実現）
- F-004 のWave数判定と連携した統合的なWave状態判定

## 入出力

- **入力**: BGR画像 (1920x1080)
- **出力**: 判定結果（"EXTRA" or "NONE"）+ 信頼度 (0.0-1.0)

## 受け入れ基準

- [ ] EXTRA WAVE 表示画面を正しく検出できること
- [ ] EXTRA WAVE 表示がない画面を正しく棄却できること
- [ ] 正検出率・正棄却率がそれぞれ 95% 以上であること
- [ ] 処理時間が 1ms 以内であること
- [ ] 実験結果が README.md に記録されていること

## テストデータ

### F-004 からの移行

F-004 で収集済みの EXTRA WAVE テストデータを移行して使用する:
- `data/test_fixtures/wave/` 内の EXTRA WAVE 画像

### 追加収集

必要に応じて追加のスクリーンショットを収集する:
- 異なるステージ・潮位のバリエーション
- FHD (1920x1080) の画面キャプチャ

## テンプレート

F-004 から以下のテンプレートを移行する:

| ファイル | 内容 |
|---|---|
| `extra_wave.npy` | 「EXTRA WAVE」全体のpHashハッシュ |

配置先は実装時に決定する（例: `assets/templates/extra_wave/`）。

## 備考

- F-004 から分離した機能。F-004 の EXTRA WAVE 判定分岐・テンプレートは本機能に移行後、F-004 から除去する
- ROI座標は EXTRA WAVE 専用に最適化する（通常Waveと共有しない）
- 認識手法の詳細は機能設計書で定義する
