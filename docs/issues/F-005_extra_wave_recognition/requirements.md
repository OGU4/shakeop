# [F-005] Extra Wave判定 — 要求仕様書

## 基本情報

| 項目 | 内容 |
|---|---|
| 管理番号 | F-005 |
| 作成日 | 2026-02-23 |
| ステータス | 📝 仕様確定 |
| 関連実験 | exp_005_extra_wave_recognition（予定） |
| 前提機能 | F-004（Wave数判定・pHash共通化） |

## 背景・目的

サーモンランNWの通常バイトでは、Wave 1~3 クリア後に一定確率で「EXTRA WAVE」が発生する。
EXTRA WAVE はオカシラシャケとの戦闘であり、通常Waveとは異なるゲーム進行となる。

本機能では、ゲーム画面の静止画から「EXTRA WAVE」テキストの有無を判定する認識機能を実装する。
F-004 で共通化した `shared/recognition/` の pHash 関数を活用する。

## 認識対象

| 表示 | 説明 |
|---|---|
| EXTRA WAVE | 通常バイト限定の特殊Wave。オカシラゲージ合計値に応じた確率で発生 |

## 画面上の表示仕様

### 表示パターン

- 「EXTRA WAVE」が一体のテキストとして画面左上に表示される（数字なし）
- 通常Wave（「WAVE N」）とはテキスト内容・ROI位置が異なる

### 表示色・背景

- テキストは **白色系** で描画
- **背景は透過** であり、ゲーム内の画面が映り込む（F-004と同様）
- HSVフィルタによる白色テキスト抽出が前処理として必要

### ROI

| 項目 | 値（FHD 1920x1080 基準） |
|---|---|
| ROI矩形 | left=38, top=35, right=238, bottom=80 |
| ROIサイズ | 200 x 45 px |

### 表示タイミング

- EXTRA WAVE 開始時（準備時間開始）から表示される
- EXTRA WAVE 終了まで継続して表示される
- Wave途中でゲームオーバー（全滅）になった場合は表示が消える

### 表示されない画面

- マッチング待ち・ロビー画面
- 通常Wave (1~5) 進行中
- Wave間の休憩時間
- リザルト画面
- その他 EXTRA WAVE 以外の全画面

## スコープ

**スコープ内:**
- 1枚の静止画に対して「EXTRA WAVE 表示あり」または「EXTRA WAVE 表示なし」を返す判定機能

**スコープ外（将来要求として扱う）:**
- EXTRA WAVE 遷移の検出（表示の出現・消滅のトリガー検知）
- 時系列安定化（複数フレームの多数決）
- ゲーム状態FSMとの連携

## 要求事項

### 必須要求 (MUST)

- EXTRA WAVE の正検出率: 95%以上
- EXTRA WAVE 表示なし画面の正棄却率: 95%以上
- pHash ベースの認識を基本方針とする
- `shared/recognition/` の `compute_phash`, `hamming_distance` を使用すること
- FHD (1920x1080) の静止画を入力として受け付けること

### 推奨要求 (SHOULD)

- 認識処理時間: 1フレームあたり 1ms 以内
- F-003 GUI認識ビューワーのプラグインとして動作すること

### 将来要求 (COULD)

- F-004 のWave数判定と連携した統合的なWave状態判定

## 入出力

- **入力**: BGR画像 (1920x1080)
- **出力**: 判定結果（"EXTRA" or "NONE"）+ 信頼度 (0.0-1.0)

## 受け入れ基準

- [ ] EXTRA WAVE 表示画面を正しく検出できること
- [ ] EXTRA WAVE 表示がない画面を正しく棄却できること
- [ ] 正検出率・正棄却率がそれぞれ 95% 以上であること
- [ ] 処理時間が 1ms 以内であること
- [ ] `shared/recognition/` の共通関数を使用していること
- [ ] 実験結果が README.md に記録されていること

## テストデータ

### 既存データ

`data/test_fixtures/wave/extra/` に EXTRA WAVE 画像が配置済み。
ネガティブケースは `data/test_fixtures/wave/` の他サブディレクトリ（wave1~5, negative）を流用する。

### テンプレート

| ファイル | 内容 | 配置先 |
|---|---|---|
| `extra_wave.npy` | 「EXTRA WAVE」全体のpHashハッシュ | `assets/templates/wave/extra_wave.npy`（保存済み） |

## 備考

- F-004 とは異なりROI全体の1段判定（WAVEテキスト/数字の分割なし）
- 閾値はミニアプリ実装時に実データで最適化する
