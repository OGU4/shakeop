# [F-005] Extra Wave判定 — 機能設計書

## 基本情報

| 項目 | 内容 |
|---|---|
| 管理番号 | F-005 |
| 要求仕様書 | [requirements.md](./requirements.md) |
| 作成日 | 2026-02-23 |
| ステータス | 📋 未着手 |
| 経緯 | F-004 から分離。ROI位置・サイズが通常Waveと異なるため独立設計とする |

## 設計方針

FHD画像の固定位置 (ROI) を切り出し、HSVフィルタで白色テキストのみを抽出（二値化）した後、
pHashでテンプレートとのハミング距離を算出して「EXTRA WAVE」の有無を判定する。

F-004 の通常Wave判定とは**ROIを独立して管理**する。
EXTRA WAVE は通常Waveよりテキストが長く、最適なROI位置・サイズが異なる可能性があるため。

## 認識フロー

```
入力: BGR画像 (1920x1080)
  │
  ▼
1. ROI切り出し（EXTRA WAVE専用ROI）
  │
  ▼
2. HSV白色テキスト抽出（前処理・二値化）
  │
  ▼
3. pHash計算 → extra_wave_hash とハミング距離比較
  │
  ├── 距離 ≤ 閾値 → "EXTRA" + 信頼度
  └── 距離 > 閾値 → "NONE" + 信頼度
```

## ROI（暫定値）

F-004 で使用していた値を初期値とし、実データで最適化する:

| 項目 | 暫定値（FHD基準） | 備考 |
|---|---|---|
| ROI矩形 | (38, 35, 238, 80) | F-004 と同一。EXTRA WAVE 専用に調整が必要な可能性あり |
| ROIサイズ | 200 x 45 px | テキスト長が長いためROI幅の拡大を検討 |

## 前処理

F-004 と同じHSV白色テキスト抽出を使用する:

| パラメータ | 値 | 備考 |
|---|---|---|
| HSV Lower | (0, 0, 210) | F-004 ステップ1で最適化された値 |
| HSV Upper | (180, 80, 255) | 同上 |
| モルフォロジー | MORPH_OPEN 3x3 | 同上 |

## テンプレート

| ファイル | 内容 | 元の管理 |
|---|---|---|
| `extra_wave.npy` | 「EXTRA WAVE」全体のpHashハッシュ | F-004 から移行 |

配置先: `assets/templates/extra_wave/`（F-004 の `assets/templates/wave/` から移動）

## 依存関係

- 前提: F-004（HSV前処理・pHash認識パターンの確立）、F-003（GUI統合先）
- 使用ライブラリ:
  - OpenCV (`cv2.img_hash.PHash`) — pHash計算
  - OpenCV (`cv2.cvtColor`, `cv2.inRange`) — HSV変換・白色抽出
  - NumPy — 配列操作

## 検証項目

| # | 検証内容 | 判定基準 |
|---|---|---|
| 1 | EXTRA WAVE の正検出率 | 95%以上 |
| 2 | 非 EXTRA WAVE 画面の正棄却率 | 95%以上 |
| 3 | ROI位置・サイズの最適値特定 | 実データで検証 |
| 4 | 処理時間 | 1フレームあたり 1ms 以内 |

## 備考

- 実装の詳細（ミニアプリ構成、プラグイン設計等）は着手時に本設計書を拡充する
- F-004 から `extra_wave.npy` テンプレートの移行、および F-004 の EXTRA WAVE 判定コード除去は本機能の着手時に実施する
