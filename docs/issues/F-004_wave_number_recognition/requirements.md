# [F-004] Wave数判定 — 要求仕様書

## 基本情報

| 項目 | 内容 |
|---|---|
| 管理番号 | F-004 |
| 作成日 | 2026-02-22 |
| ステータス | ✅ 確定 |
| 関連実験 | exp_004_wave_number_recognition（予定） |
| 前提機能 | F-001（pHash認識基盤）、F-003（GUI認識ビューワー） |

## 背景・目的

サーモンランNWでは、ゲーム中に現在のWave番号が画面上の決まった位置に表示される。
本機能では、ゲーム画面の静止画からWave数を判定する認識機能を実装する。

Wave番号を正確に認識することで、Wave進行状況のリアルタイム把握が可能になり、
将来的にはWave開始/終了の検出やWave別の統計情報表示に繋がる。

## Wave の種類

サーモンランNWには以下のWaveが存在する（ゲームモードにより異なる）：

| ゲームモード | 出現するWave | 備考 |
|---|---|---|
| 通常のバイト | Wave 1 ~ 3 + Extra Wave | 計4種類 |
| バイトチームコンテスト | Wave 1 ~ 5 | 不定期開催。Extra Waveなし |

**本機能が認識対象とするWaveの一覧（両モードの和集合）:**

| Wave | 説明 |
|---|---|
| Wave 1 | 通常Wave（1番目） |
| Wave 2 | 通常Wave（2番目） |
| Wave 3 | 通常Wave（3番目） |
| Wave 4 | 通常Wave（4番目）— バイトチームコンテスト限定 |
| Wave 5 | 通常Wave（5番目）— バイトチームコンテスト限定 |

> Extra Wave の認識は F-005 に分離。本機能では扱わない。

## 画面上の表示仕様

### Wave表示の位置と構成

ゲーム中、画面左上のHUDエリアにWave表示が存在する。

**ROI参考情報**（外部プロジェクト ShakeScouter-NW の実装値）:

| 項目 | 値（FHD 1920x1080 基準） |
|---|---|
| ROI矩形 | left=38, top=35, right=238, bottom=80 |
| ROIサイズ | 200 x 45 px |

> ⚠ 上記は参考値。実際のゲーム画面で検証し、必要に応じて調整すること。

### 表示パターン

本機能が認識対象とする表示パターン：

| パターン | 表示内容 | 視覚的構成 |
|---|---|---|
| 通常Wave | 「WAVE N」（N = 1~5） | 左側に「WAVE」固定テキスト + 右側に数字 |

> Extra Wave（「EXTRA WAVE」表示）の認識は F-005 に分離。

ShakeScouter-NWでは、ROI内を以下のように2分割して認識している（参考）：
- **左128px**: 「WAVE」テキスト部分 — テンプレートマッチングでWave表示の有無を判定
- **右72px**: 数字部分 — Wave番号（1~5）の認識

### 表示色・背景

- Wave表示テキストは **白色系** で描画されている
- **背景は透過** であり、ゲーム内の画面（ステージ・キャラクター・エフェクト等）が映り込む
  - つまり背景は毎フレーム変化し、一定ではない
  - これにより、ROI全体をそのままpHashに通すと背景ノイズの影響を受ける可能性がある
  - **前処理で白色テキストのみを抽出（二値化）してから認識する**ことが重要になる

ShakeScouter-NWでは以下のHSVフィルタで白色ピクセルを抽出している（参考）：

```
HSV InRange: lower=[0, 0, 200], upper=[180, 80, 255]
→ 任意の色相 / 低彩度(≤80) / 高明度(≥200) = 白色系ピクセルのみ通過
```

この前処理により、背景の映り込みを除去し、テキスト部分のみを白黒二値画像として取り出している。

### Wave表示のタイミング

**表示される期間:**
- Wave表示は各Waveの **準備時間（10カウント）開始時点** から表示される
- **本番（100カウント）終了まで** 継続して表示される（途中で消えることはない）
- ただし、Wave途中でゲームオーバー（全滅）になった場合は表示が消える

**表示されない画面（「判定不能」として正しく棄却する必要がある）:**
- マッチング待ち・ロビー画面
- ステージ紹介・「バイトの時間です」表示中
- Wave間の休憩時間
- リザルト画面
- メニュー画面・ホーム画面
- ゲームオーバー画面（「Works Over!」表示）

## スコープ

本機能（F-004）のスコープは **静止画1枚からのWave数判定** である。

**スコープ内:**
- 1枚の静止画に対して「今 Wave N である」または「Wave表示なし」を返す判定機能

**スコープ外（将来要求として扱う）:**
- Wave遷移の検出（Wave表示の出現・消滅・番号変化のトリガー検知）
- 時系列安定化（複数フレームの多数決）
- ゲーム状態FSMとの連携

## 要求事項

### 必須要求 (MUST)

#### 認識対象

- Wave 1 ~ Wave 5 の計5種類を判定できること（Extra Wave は F-005 に分離）
- ゲーム画面（1920x1080 FHD）の静止画を入力として受け付けること
- Wave表示が存在しない画面（非Wave中、メニュー画面等）を「判定不能」として区別できること

#### 実装ステップ

本機能の実装は以下の2ステップに分けて行う：

**ステップ1: CLI版（単体動作）**
- コマンドラインから画像ディレクトリを指定し、その中の全画像ファイルに対してWave数の判定結果を出力する単体アプリ
- `experiments/exp_004_wave_number_recognition/` にミニアプリとして作成
- `--image-dir` オプションで画像ディレクトリパスを指定（ディレクトリ内の全画像ファイルを一括処理）
- `--debug` オプションでROI可視化・詳細情報を表示
- 判定結果はテキストファイルに出力する（ファイル名: `YYMMDD-hhmmss_wave_result.txt`）

**ステップ2: GUI統合版**
- F-003（GUI認識ビューワー）の認識プラグインとして統合
- RecognitionPlugin Protocol に準拠したプラグインクラスを実装
- GUI上でリアルタイムにWave数を認識・表示

#### 認識手法

- pHash（パーセプチュアルハッシュ）ベースの認識を基本方針とする（プロジェクトの設計方針に準拠）
- ShakeScouter-NWではCNN（PyTorch）による数字認識を採用しているが、本プロジェクトではpHashを使用する
  - 理由: Wave番号は1~5の固定5パターンのみであり、pHashで十分対応可能
- 具体的な認識手法（ROI分割方式 or 全体マッチング方式等）は機能設計書で決定する

#### 精度

- Wave 1 ~ 5 の正答率: 95%以上
- Wave表示なし画面の正棄却率: 95%以上

### 推奨要求 (SHOULD)

- 認識処理時間: 1フレームあたり 1ms 以内（pHash方式の場合）
- テンプレート画像の収集・管理方法を文書化すること

### 将来要求 (COULD)

- 動画入力（カメラ）への対応（F-003統合で実現）
- Wave遷移の検出（Wave N → Wave N+1 の変化を検知）
- 時系列安定化（Nフレーム多数決によるチラつき防止）

## 入出力

### ステップ1（CLI版）

- **入力**: 画像ディレクトリパス（ディレクトリ内の全画像ファイル、BGR, 1920x1080）
- **出力**: テキストファイル（`YYMMDD-hhmmss_wave_result.txt`）
  - 各画像のファイル名、Wave判定結果（Wave番号 or 判定不能）、信頼度を1行ずつ記録
  - 出力先はミニアプリディレクトリ内（例: `experiments/exp_004_wave_number_recognition/results/`）

### ステップ2（GUI統合版）

- **入力**: カメラからのBGR動画ストリーム（1920x1080）
- **出力**: GUI上のオーバーレイ表示 + ログ出力

## 受け入れ基準

### ステップ1（CLI版）

- [ ] `--image-dir` でディレクトリを指定し、全画像のWave判定結果が `YYMMDD-hhmmss_wave_result.txt` に出力されること
- [ ] Wave 1 ~ 5 を正しく判定できること
- [ ] Wave表示がない画面を「判定不能」と判定できること
- [ ] `--debug` でROI矩形と判定結果の可視化ができること
- [ ] 実験結果が README.md に記録されていること

### ステップ2（GUI統合版）

- [ ] F-003のGUI認識ビューワーのプラグインとして動作すること
- [ ] RecognitionPlugin Protocol に準拠していること
- [ ] GUI上でリアルタイムにWave数が認識・オーバーレイ表示されること
- [ ] プラグインドロップダウンから選択・切替ができること
- [ ] テンプレートファイルが1つでも欠けている場合、FileNotFoundError で起動失敗すること
- [ ] 検証は実機（キャプチャボード接続）での目視確認で行うこと

## ステップ2 詳細仕様

### 概要

ステップ1で実装・検証済みの `WaveNumberRecognizer` を、F-003 GUI認識ビューワーのプラグインとしてラップする。
新規の認識ロジックは追加せず、既存の認識器をGUIフレームワークに接続することが目的。

### プラグイン仕様

| 項目 | 値 |
|---|---|
| クラス名 | `WaveNumberPlugin` |
| 配置先 | `experiments/exp_003_gui_recognition_viewer/plugins/wave_number.py` |
| GUI表示名 (`name`) | `"Wave数判定"` |
| 準拠Protocol | `RecognitionPlugin`（`recognition_plugin.py`） |
| ラップ対象 | `exp_004_wave_number_recognition/wave_recognizer.py` の `WaveNumberRecognizer` |

### テンプレート読み込み

- テンプレートディレクトリ: `assets/templates/wave/`
- 必要ファイル（全6ファイル）:
  - `wave_text.npy` — 「WAVE」テキスト部のpHashハッシュ
  - `digit_1.npy` ~ `digit_5.npy` — 数字1~5のpHashハッシュ
- **全ファイルが揃っていなければ `FileNotFoundError` で起動失敗**とする（部分動作は不可）
- `__init__()` の引数 `template_dir: Path | None` で外部からディレクトリを差し替え可能

### process() の戻り値

```python
{
    "detected": bool,        # Wave表示が検出されたか（NONE以外ならTrue）
    "confidence": float,     # 信頼度 0.0-1.0
    "wave_result": str,      # "WAVE_1"~"WAVE_5", "NONE"
}
```

### オーバーレイ描画仕様 (draw_overlay)

| 項目 | 仕様 |
|---|---|
| ROI矩形の色 | 検出時（detected=True）: **緑** `(0, 255, 0)` / 未検出時: **赤** `(0, 0, 255)` |
| テキスト表示位置 | ROI矩形の下部 |
| テキストフォーマット | `WAVE_3 conf=0.9531` / `NONE conf=0.3125` |
| フォント | `cv2.FONT_HERSHEY_SIMPLEX` |

既存プラグイン `baito_text.py` の描画パターンを踏襲する。

### ログフォーマット (format_log)

```
wave=WAVE_1   confidence=0.9531
wave=NONE     confidence=0.3125
```

### プラグイン登録

`exp_003_gui_recognition_viewer/main.py` の `_load_plugins()` に `WaveNumberPlugin` を追加登録する。
既存の `BaitoTextPlugin` と同じパターン（try/except で読み込み失敗時に警告表示）。

### スコープ外

以下はステップ2のスコープに含めない:
- `WaveNumberPlugin` のユニットテスト作成（src/ 統合時に行う）
- `exp_004` の README 更新
- 精度の再検証（ステップ1で検証済み）

## テストデータの方針

テスト用スクリーンショットは **仕様確定後にゲームをプレイして収集する**。

### 収集するデータ

| カテゴリ | 内容 | 最低枚数目安 |
|---|---|---|
| Wave 1 ~ 5（各） | 通常Wave表示中のスクリーンショット | 各Wave 3枚以上 |
| ネガティブケース | Wave表示が存在しない画面（ロビー、リザルト、休憩時間等） | 5枚以上 |

### 配置先

- テストフィクスチャ: `data/test_fixtures/wave/`（予定）
- テンプレート画像: `assets/templates/wave/`（予定）

### 収集時の注意

- 異なるステージ・潮位で撮影すること（背景が透過のため、背景バリエーションが認識精度検証に重要）
- 準備時間中・本番中の両方を含めること
- FHD (1920x1080) の画面キャプチャを使用すること

## 参考資料

### ShakeScouter-NW（外部プロジェクト）

本要求仕様書の作成にあたり、`/home/ogu4/git/ShakeScouter-NW` のソースコードを調査し、ROI座標・前処理フィルタ・表示パターンの情報を参考にした。

| 項目 | ShakeScouter-NWの実装 | 本プロジェクトでの方針 |
|---|---|---|
| Wave数字の認識 | PyTorch CNN（数字認識モデル） | pHash（テンプレートマッチング） |
| Wave表示の検出 | MAE（平均絶対誤差）テンプレート比較 | pHash |
| ROI座標 | (38, 35, 238, 80) — 200x45px | 参考値として採用し検証する |
| 前処理 | HSV変換 + InRange(白色抽出) | 参考にして検証する |
| 判定閾値 | MAE ≤ 0.1 | pHashハミング距離で再定義 |

主要な参照ファイル:
- `ShakeScouter/constants/screen.py` — ROI定義
- `ShakeScouter/scenes/ingame/wave.py` — Wave認識ロジック
- `ShakeScouter/templates/wave.png`, `wave_ex.png` — テンプレート画像

## 備考

- ミニアプリとして experiments/ に作成する。src/ への統合は行わない
- 認識手法の詳細（ROI座標、テンプレート収集方法等）は機能設計書で定義する
- ROI座標はShakeScouter-NWの参考値 (38, 35, 238, 80) を基に、実際のゲーム画面で検証して確定する
