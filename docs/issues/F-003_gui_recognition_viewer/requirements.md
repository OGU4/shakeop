# [F-003] GUI認識ビューワー — 要求仕様書

## 基本情報

| 項目 | 内容 |
|---|---|
| 管理番号 | F-003 |
| 作成日 | 2026-02-22 |
| ステータス | ✅ 完了 |
| 関連実験 | exp_003_gui_recognition_viewer |
| 前提機能 | F-001（pHashテキスト認識）、F-002（動画テキスト認識） |

## 背景・目的

F-002ではOpenCVウィンドウとコンソール出力による動画テキスト認識を実現したが、
操作性・視認性に課題がある（入力ソースの切替にCLI引数が必要、認識結果がコンソール出力のみ等）。

本機能では PySide6 ベースの GUI ミニアプリを作成し、以下を実現する：

1. **操作性向上**: GUI上で入力ソース（`/dev/video*`）を選択・切替できるようにする
2. **可視化**: 映像上に認識結果をオーバーレイ表示し、検出状態を視覚的に把握できるようにする
3. **拡張性**: 将来的に別の認識機能（別の位置のテキスト、オブジェクト検出等）を差し替え可能な設計にする
4. **ログ出力**: 認識結果をテキストファイルに記録できるようにする
5. **性能可視化**: 処理ベースのフレームレートをGUI上に表示する

## 要求事項

### 必須要求 (MUST)

#### GUI全般

- PySide6ベースのGUIアプリケーションとして動作すること
- CLI引数は不要。全ての設定はGUI上で行う
- 起動直後は停止状態とし、ユーザーがカメラを選択して手動で開始する

#### 映像表示

- カメラからの映像をGUI上にリアルタイム表示すること
- 映像はウィンドウサイズに合わせてスケーリング表示すること（アスペクト比維持）

#### カメラ入力

- `/dev/video*` デバイスを列挙し、GUI上のドロップダウンで選択できること
- デバイスリストの更新ボタンを設けること
- カメラ動作中に別のカメラデバイスに切り替え可能であること（自動で再接続）

#### 認識処理

- F-002の「バイトの時間です」テキスト認識機能を組み込み、認識処理を実行できること
- 全フレームに対して認識処理を行うこと（フレームスキップなし）
- 認識機能の動作中切替が可能であること（カメラを止めずにプラグインを変更できる）

#### 認識結果オーバーレイ

- 映像フレーム上に認識結果をオーバーレイ表示すること（F-002のdebugモードと同等）
  - ROI矩形の描画（検出時: 緑 `(0,255,0)`、未検出時: 赤 `(0,0,255)`）
  - 判定結果テキスト（`DETECTED` / `NOT DETECTED`）と信頼度の表示

#### FPS表示

- 処理ベースのフレームレート（認識処理を完了した実際のFPS）をGUI上に表示すること

#### 認識プラグイン設計

- 認識機能を「プラグイン」として差し替え・追加できる拡張性のある設計にすること
- 同時に使用する認識機能は1つとする（排他的切替）
- GUI上のドロップダウンで使用する認識機能を選択できること
- 初期プラグインとして「バイトの時間です」テキスト認識を実装する

#### テキストログ出力

- 認識結果をテキストファイルに出力する機能を持つこと
- この機能の有効/無効をGUI上のチェックボックスで切り替えられること
- テキストファイルの保存先をGUI上で指定・変更できること
- デフォルトの保存先はミニアプリ直下（`experiments/exp_003_gui_recognition_viewer/output.log`）
- 全フレームの認識結果を1行ずつ出力すること

#### 操作ボタン

- 開始/停止は1つのトグルボタンで制御すること（押すたびに開始⇔停止が切り替わる）

#### エラー処理

- カメラが開けない場合やカメラ切断時は、GUI上にエラーメッセージを表示する（最小限）
- 自動リトライは行わない。ユーザーが手動で再選択・再開する

### 推奨要求 (SHOULD)

- カメラデバイスの接続/切断に動的に対応できること（リスト更新ボタンで反映）
- 認識結果の変化検知時（False→True, True→False）にログに強調表示すること
- テキストログにタイムスタンプを含めること

### 将来要求 (COULD)

- 複数の認識機能の同時使用
- 時系列安定化（Nフレーム多数決によるチラつき防止）
- メインアプリへの統合
- フレームスキップによる処理FPS制御

## 入出力

- **入力**: `/dev/video*` カメラデバイスからのBGR動画ストリーム (1920x1080)
- **出力**:
  - GUI: 映像＋認識結果オーバーレイ＋FPS表示
  - テキストファイル（任意）: 認識結果ログ

## GUIレイアウト

```
┌──────────────────────────────────────────────────────┐
│ GUI認識ビューワー                              [_][□][×] │
├──────────────────────────────────────────────────────┤
│ カメラ: [/dev/video10 ▼] [更新]                        │
│ 認識機能: [バイトの時間です ▼]                           │
│ [▶ 開始 / ■ 停止]  (トグルボタン)                       │
│ ☐ ログ出力  保存先: [output.log] [参照...]              │
├──────────────────────────────────────────────────────┤
│                                                      │
│              映像表示エリア                             │
│      (ウィンドウサイズに合わせてスケーリング)             │
│       (認識結果オーバーレイ付き)                         │
│                                                      │
├──────────────────────────────────────────────────────┤
│ FPS: 30.0                                            │
└──────────────────────────────────────────────────────┘
```

- コントロールパネル: 上部
- 映像表示: 中央（メインエリア、スケーリング対応）
- ステータスバー: 下部（FPS表示）

## 認識プラグイン仕様

### プラグインが提供すべき機能

各プラグインは以下を提供する：

| 機能 | 説明 |
|---|---|
| 名前 | GUI表示用のプラグイン名 |
| 認識処理 | フレーム入力 → 認識結果出力 |
| オーバーレイ描画 | フレーム上に認識結果を可視化 |
| ログフォーマット | 認識結果をログ文字列に変換 |

### 初期プラグイン

| プラグイン名 | 内容 | 元機能 |
|---|---|---|
| バイトの時間です | 「バイトの時間です」テキスト認識 | F-001 / F-002 |

### 将来追加が想定されるプラグイン例

| プラグイン名 | 内容 |
|---|---|
| Wave開始テキスト | Wave開始テキスト認識 |
| ノルマ数字 | ノルマ数字認識 |

## テキストログ出力仕様

### 形式

```
2026-02-22 15:30:01.123  detected=True   confidence=0.9844
2026-02-22 15:30:01.156  detected=False  confidence=0.5156
2026-02-22 15:30:01.189  detected=True   confidence=0.9688
```

- 1行1フレーム（毎フレーム出力）
- タイムスタンプ（ミリ秒精度） + 認識結果 + 信頼度
- UTF-8エンコーディング
- デフォルト保存先: `experiments/exp_003_gui_recognition_viewer/output.log`

### ファイル管理

- サイズ制限・ローテーションは初期実装では不要
- ログ有効化時にファイルを開き、無効化時にファイルを閉じる
- 既存ファイルがある場合は追記モード

## 受け入れ基準

- [x] PySide6ベースのGUIウィンドウが起動すること
- [x] 起動直後は停止状態であること
- [x] `/dev/video*` デバイスがGUI上でリスト表示され、選択・切替できること
- [x] カメラ動作中にカメラデバイスを切り替えられること
- [x] 選択したカメラからの映像がGUI上にリアルタイム表示されること
- [x] 映像がウィンドウサイズに合わせてスケーリング表示されること
- [x] 「バイトの時間です」テキスト認識がGUI上で動作し、結果がオーバーレイ表示されること
- [x] オーバーレイにROI矩形（緑/赤）と検出状態テキスト+信頼度が表示されること
- [x] カメラ動作中に認識プラグインを切り替えられること
- [x] トグルボタンで開始/停止の切り替えができること
- [x] 処理FPSがGUI上に表示されること
- [x] テキストログ出力の有効/無効をGUI上で切り替えられること
- [x] テキストログの保存先をGUI上で指定・変更できること
- [x] カメラが開けない場合にGUI上にエラーメッセージが表示されること
- [ ] 実験結果が experiments/exp_003_gui_recognition_viewer/README.md に記録されていること

## 備考

- ミニアプリとして experiments/ に作成する。src/ への統合は行わない
- 認識ロジックはF-001/F-002の実装をimportして使用する（再実装しない）
- GUIフレームワークはPySide6を使用（プロジェクトの技術スタックに準拠）
- 映像表示にはOpenCVで取得したフレームをQImageに変換してQLabel/QPixmap等に描画する方式を想定
- CLI引数は持たない。全ての設定はGUI上で行う
